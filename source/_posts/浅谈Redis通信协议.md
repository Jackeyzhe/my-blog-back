---
title: 浅谈Redis通信协议
date: 2019-06-23 19:04:10
tags: Redis
comments: true
---

Redis客户端和服务器端使用的通信协议叫做RESP（Redis Serialization Protocol）。它是特意为Redis设计的，同时也可以用于其他软件工程。<!-- more -->

RESP在以下事项之间进行妥协：

- 实现简单
- 快速解析
- 可读性强

RESP可以序列化多种不同的数据类型，比如：整型、字符串、数组。错误是一种特定的类型。Redis客户端把参数用数组来表示。回复的是一种特殊的数据格式。

RESP是二进制安全的，它不需要处理从一个进程到另一个进程的批量数据，因为采用的是前缀长度来传输批量数据。

*注意：这里的协议只适用用与客户端-服务器通信。Redis集群使用的是不同的协议*

一般情况下，RESP是一种简单的请求-响应式协议。二般情况是：

- Redis支持管道，所以有可能一次发送多个命令，然后一起响应
- 如果Redis客户端订阅了Pub/Sub频道，那么协议就会变成一种推送协议，当服务器接收到新的数据时会自动推送给客户端

RESP协议支持的数据类型有：Simple Strings，Errors，Integers，Bulk Strings和Arrays。它的使用方法有：

- 客户端以Bulk Strings数组的形式发送命令
- 服务器端返回的结果是协议支持的类型之一

RESP协议中，上述类型是通过首个字节区分的：

- `+`代表简单字符串（Simple Strings）
- `-`代表错误类型（Errors）
- `:`代表整型（Integers）
- `$`代表多行字符串（Bulk Strings）
- `*`代表数组（Arrays）

此外，每一部分结束时，Redis统一使用“\r\n”表示结束。

看到这里你是否有疑问呢？为什么没有表示null的方法呢？别着急我们一会就会解释。

##### RESP简单字符串

简单字符串中不允许出现`\r`或`\n`，只能有一行。它用于以最小开销传输非二进制安全字符串，例如回复的OK

``` bash
"+OK\r\n"
```

如果要发送二进制安全的字符串，应该使用多行字符串。

##### RESP错误

RESP有特定的错误类型，它与简单字符串类似，只不过是把开头的`+`换成了`-`，而两者之间真正的区别是客户端将错误视为异常，而错误中的字符串只是表示错误信息。

``` bash
"-Error message\r\n"
```

当客户端收到错误信息时，通常会抛出一个异常。我们来看一些例子：

``` bash
-ERR unknown command 'foobar'
-WRONGTYPE Operation against a key holding the wrong kind of value
```

从第一个字符“-”之后，到第一个空格或新的一行，这之间的字符串表示错误类型。这只是Redis的一种约定，并不是RESP的错误格式。

例如ERR是普通错误，而WRONGTYPE表示客户端试图对错误的数据类型执行操作。

##### RESP整型

整型只是以`\r\n`结尾，以`:`开头的纯整数的字符串。

``` bash
:1000\r\n
```

很多Redis命令都会返回整型，例如INCR、LLEN和LASTSAVE。

返回的整数需要在64位有符号整数范围内，同时也可以用于表示真或假。

##### RESP多行字符串

多行字符串是二进制安全的，最大长度是512MB。

多行字符串的编码方式如下：

- 以`$`+数字开头，以`\r\n`结束
- 数据都是字符串
- 结尾是`\r\n`

所以“foobar”应该编码为

```bash
"$6\r\nfoobar\r\n"
```

空字符串表示为：

``` bash
"$0\r\n\r\n"
```

多行字符串也可以用来null

``` bash
"$-1\r\n"
```

当服务器返回Null多行字符串时，正常客户端是不应该返回空字符串的，而是应该返回nil对象。

##### RESP数组

客户端向服务器端发送命令时使用的就是RESP数组。类似的，某些命令返回的元素集合也是RESP数组的类型。

RESP数组遵循以下规则：

- 第一个字符是`*`，后面跟的十进制数字是数组元素的数量，然后跟着`\r\n`。
- 每个元素都是RESP类型的

空数组表示为：

```  bash
"*0\r\n"
```

数组中的元素可以是不同类型的：

``` bash
*5\r\n
:1\r\n
:2\r\n
:3\r\n
:4\r\n
$6\r\n
foobar\r\n
```

第一行的`*5\r\n`表示数组有5个元素，后面每行是一个元素。

RESP也有NULL数组的表示方法，这是NULL的另一种表示方法，通常用多行字符串的NULL来表示，不过由于历史原因，就保留了两种形式。

当BLPOP命令超时时，就会返回NULL数组

``` bash
"*-1\r\n"
```

当服务器返回NULL数组时，客户端应该返回null对象而不是空数组。

##### 数组中的NULL

数组中的元素可以是NULL，通常表示数组中某个元素缺失，而不是空字符串：

``` bash
*3\r\n
$3\r\n
foo\r\n
$-1\r\n
$3\r\n
bar\r\n
```

其中第二个元素时NULL，客户端的返回结果应该是：

``` bash
["foo",nil,"bar"]
```

##### 小结

到此我们已经了解了RESP协议，RESP中虽然有大量的冗余`\r\n`，但是仍然有很多开源项目使用。